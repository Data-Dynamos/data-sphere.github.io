<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-beyond-the-batch/handling-late-data">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.0">
<title data-rh="true">Handling Late Data |  DataSphere</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://data-dynamos.github.io/data-sphere.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://data-dynamos.github.io/data-sphere.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://data-dynamos.github.io/data-sphere.github.io/docs/beyond-the-batch/handling-late-data"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Handling Late Data |  DataSphere"><meta data-rh="true" name="description" content="We have seen that Spark Structured applications can store and aggregate data across micro-batches. Spark runtime stores this data in what Spark calls a statestore. This statestore uses the executor memory of the worker machines. Now a couple of questions have probably crossed your mind:"><meta data-rh="true" property="og:description" content="We have seen that Spark Structured applications can store and aggregate data across micro-batches. Spark runtime stores this data in what Spark calls a statestore. This statestore uses the executor memory of the worker machines. Now a couple of questions have probably crossed your mind:"><link data-rh="true" rel="icon" href="/data-sphere.github.io/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://data-dynamos.github.io/data-sphere.github.io/docs/beyond-the-batch/handling-late-data"><link data-rh="true" rel="alternate" href="https://data-dynamos.github.io/data-sphere.github.io/docs/beyond-the-batch/handling-late-data" hreflang="en"><link data-rh="true" rel="alternate" href="https://data-dynamos.github.io/data-sphere.github.io/docs/beyond-the-batch/handling-late-data" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/data-sphere.github.io/blog/rss.xml" title=" DataSphere RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/data-sphere.github.io/blog/atom.xml" title=" DataSphere Atom Feed"><link rel="stylesheet" href="/data-sphere.github.io/assets/css/styles.5e85331d.css">
<link rel="preload" href="/data-sphere.github.io/assets/js/runtime~main.2d4a7005.js" as="script">
<link rel="preload" href="/data-sphere.github.io/assets/js/main.2340525f.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/data-sphere.github.io/"><div class="navbar__logo"><img src="/data-sphere.github.io/img/datasphere_1.jpeg" alt="My Site Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/data-sphere.github.io/img/datasphere_1.jpeg" alt="My Site Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">DataSphere</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/data-sphere.github.io/docs/category/pre-requisite">Lessons</a><a class="navbar__item navbar__link" href="/data-sphere.github.io/resources">Resources</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/Data-Dynamos/data-sphere.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/data-sphere.github.io/docs/category/pre-requisite">Pre Requisite</a><button aria-label="Toggle the collapsible sidebar category &#x27;Pre Requisite&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/data-sphere.github.io/docs/tour_agenda">Tour Agenda</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/data-sphere.github.io/docs/category/intro-to-data-engineering">Intro to Data Engineering</a><button aria-label="Toggle the collapsible sidebar category &#x27;Intro to Data Engineering&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/data-sphere.github.io/docs/The-Art-of-Data-Engineering:Crafting-Robust-and-Scalable-Solutions/data-milky-way-brief-history-part-1">The Art of Data Engineering:Crafting Robust and Scalable Solutions ðŸš€ </a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/data-sphere.github.io/docs/Real-time-Problem-Statement/Problem-statement">Real time Problem Statement ðŸ”‹</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/data-sphere.github.io/docs/SQL/sql-quick-review">Structured Query Language (SQL)</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/data-sphere.github.io/docs/data-platforms/basics-of-a-data-platform">Data Platforms</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/data-sphere.github.io/docs/batch-processing/multi-hop-medallion-domain-questions">Batch Processing</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/data-sphere.github.io/docs/data-quality/data_reliability">Data Quality</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/data-sphere.github.io/docs/data-privacy/overview">Data Privacy</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/data-sphere.github.io/docs/data-visualisation/understanding-your-data">Data Visualisation</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/data-sphere.github.io/docs/beyond-the-batch/intro-to-streaming">Beyond the Batch</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/data-sphere.github.io/docs/beyond-the-batch/intro-to-streaming">Intro to Streaming</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/data-sphere.github.io/docs/beyond-the-batch/spark-structured-streaming">Spark Structured Streaming</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/data-sphere.github.io/docs/beyond-the-batch/stateful-vs-stateless-streaming">Stateful vs. Stateless Streaming</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/data-sphere.github.io/docs/beyond-the-batch/checkpointing">Checkpointing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/data-sphere.github.io/docs/beyond-the-batch/handling-late-data">Handling Late Data</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/data-sphere.github.io/docs/beyond-the-batch/stateful-streaming-nutshell">Stateful Streaming in a Nutshell</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/data-sphere.github.io/docs/beyond-the-batch/sharing-streaming-data">Sharing Streaming Data</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/data-sphere.github.io/docs/beyond-the-batch/exercise-streaming">Exercise: Streaming</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/data-sphere.github.io/docs/beyond-the-batch/streaming-technologies">Driving Streaming in Production</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/data-sphere.github.io/docs/data-science-and-interpretability/data-science-data-requirements">Data Science and Interpretability</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/data-sphere.github.io/docs/data-mesh/intro">Data Mesh ðŸ•¸</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/data-sphere.github.io/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Beyond the Batch</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Handling Late Data</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Handling Late Data</h1><p>We have seen that <a href="/data-sphere.github.io/docs/beyond-the-batch/stateful-vs-stateless-streaming">Spark Structured applications can store and aggregate data across micro-batches</a>. Spark runtime stores this data in what Spark calls a <code>statestore</code>. This statestore uses the executor memory of the worker machines. Now a couple of questions have probably crossed your mind:</p><ol><li>Does Spark statestore store the data forever? Yes, at least until the application crashes or it is brought down for routine housekeeping. Spark Streaming applications are designed to handle these kinds of interruptions in this fashion.</li><li>Should we keep the data in the statestore of the Spark Streaming Application forever? Well, not really, for 2 reasons below:<ol><li>As mentioned above, the statestore uses the executor memory which is finite and will sooner or later get exhausted. This usually results in either the Spark job being stuck for a very long time or ultimately crashing.</li><li>The use case might not require you to store the data forever. For example, you may have an application where you would want to see the running totals of the invoices of the last 1 hour. Every hour, you would want to move the data to an external storage and clean the statestore.</li></ol></li></ol><p>Above are just a few examples where you might not want to maintain the data in your application forever. This is where the concept of windows and late data comes into picture.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="time-windows">Time Windows<a href="#time-windows" class="hash-link" aria-label="Direct link to Time Windows" title="Direct link to Time Windows">â€‹</a></h2><p>Windows are an important temporal concept for managing data and its state in Spark Streaming applications. They are the time intervals on which we can segregate and aggregate the incoming streaming data from the source. The time for which such windows are created is usually the Event Time i.e the timestamp for which the data was generated at the source. Please note that the aforementioned Event Time is different from the Trigger time, which is the start time of the micro-batch by the Spark runtime. Also note that Time Windows are used only for Stateful Spark Streaming applications because, afterall, we are trying to efficiently manage the state so that our applications do not store the data forever.</p><p>There are two types of Time Windows in Spark Streaming:</p><ul><li>Tumbling Time windows</li><li>Sliding Time windows</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="tumbling-time-windows">Tumbling Time windows<a href="#tumbling-time-windows" class="hash-link" aria-label="Direct link to Tumbling Time windows" title="Direct link to Tumbling Time windows">â€‹</a></h3><p>Tumbling Windows are fixed, non-overlapping and contiguous (or back-to-back) time windows that we can create based on the Event time. For Eg. A 15 minute tumbling window can be created for data generated between 12:00 PM to 12:15 PM, 12:15 PM to 12:30 PM and so on. Let us understand the concept of tumbling window in more detail with the help of an example below:</p><p>Letâ€™s say we are developing an application which is processing the data generated from a stock market application. The stock market application is sending data in the following on periodic basis to our application:</p><table><thead><tr><th align="center">Field</th><th align="center">Type</th></tr></thead><tbody><tr><td align="center">EventTime</td><td align="center">String</td></tr><tr><td align="center">Symbol</td><td align="center">String</td></tr><tr><td align="center">Price</td><td align="center">String</td></tr></tbody></table><p>Our application should receive the above data and create a <strong>1 minute tumbling time window</strong>. Also, to demonstrate the windowing aggregates, our application should sum up all the prices for the stock symbol generated within each time window of 1 minute.</p><p>To implement the above example, we will use the netcat application (Socket Source) from our previous <a href="/data-sphere.github.io/docs/beyond-the-batch/checkpointing">examples</a> to simulate data streaming from the stock market application. Note: the full application code below can be found <a href="https://github.com/data-derp/exercise-vanilla-spark/tree/main/src" target="_blank" rel="noopener noreferrer">here</a>; please follow the <a href="https://github.com/data-derp/exercise-vanilla-spark/tree/main#readme" target="_blank" rel="noopener noreferrer">README</a> to ensure that all dependencies are satisfied before running it. We will start by writing the Spark Streaming code for the above application requirement to receive the <code>Event Time, Symbol, Price</code> from the source:</p><ol><li><p>Start with reading the data from the source</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> spark </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> SparkSession \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">builder \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">appName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Tumbling Window Wordcount&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getOrCreate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> spark</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sparkContext</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">setLogLevel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;ERROR&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> socketStreamDF </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> spark</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">readStream \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">format</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;socket&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">option</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;host&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;localhost&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">option</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;port&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9999</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">load</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>Split the data and create columns like <code>EventTime</code>, <code>Symbol</code> and <code>Price</code> and store the reference in <code>stocksDF</code> dataframe</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">stocksDF </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> socketStreamDF</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">withColumn</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;value&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> split</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;value&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;,&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">\</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">withColumn</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;EventTime&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> to_timestamp</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">col</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;value&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">withColumn</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;symbol&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> col</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;value&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">withColumn</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;price&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> col</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;value&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cast</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">DoubleType</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>Create a Time Window of 1 minute. Note that Time Windows are created by using the <code>groupBy</code> transformation followed by some kind of aggregation. This essentially means that we are creating aggregating windows of 1 minute each which will later on help to decide which events to keep or discard.</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Group the data by window and word and compute the count of each group</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">windowedWords </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> stocksDF\</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">groupBy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">window</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;EventTime&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;1 minute&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> stocksDF</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">symbol</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">\</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">agg</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">max</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;price&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alias</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;maxPrice&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>Lastly, write the data to the output console sink:</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># This is like writing the data to the sink, console in this case</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">query </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> windowedWords \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">writeStream \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">outputMode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;complete&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">format</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;console&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">option</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;truncate&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;false&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">start</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>You can get the complete code of this example <a href="https://github.com/data-derp/exercise-vanilla-spark/blob/main/src/11%20-%20StreamingTumblingWindow.py" target="_blank" rel="noopener noreferrer">here</a></p></li></ol><p>Run the application</p><ol><li>Open a fresh terminal window and open netcat at port <code>9999</code> as shown below:
<img loading="lazy" alt="Start-NetCat.png" src="/data-sphere.github.io/assets/images/Start-NetCat-980ebc8ba58636da4098cb08f08c9933.png" width="1618" height="192" class="img_ev3q"></li><li>Run the above program from Pycharm. Press Ctrl+Shift+R on your keyboard to run this. Alternatively, you can also open the program in Pycharm and press the execute button as shown below.
<img loading="lazy" alt="Pycharm-Run-Program.png" src="/data-sphere.github.io/assets/images/Pycharm-Run-Program-813daa7233060b42a840ca452014024f.png" width="2800" height="932" class="img_ev3q"></li><li>You should be able to see the first empty batch with <code>window</code>, <code>symbol</code> and <code>maxPrice</code> columns.</li><li>Let us now send <code>2023-04-24 12:00:05,AAPL,500</code> as data from netcat terminal.</li><li>You should be able to see this data with corresponding time window being created in Pycharm output as below:
<img loading="lazy" alt="Tumbling-Window-Batch-1.png" src="/data-sphere.github.io/assets/images/Tumbling-Window-Batch-1-77282896f64368985aafa6f564c64985.png" width="1752" height="516" class="img_ev3q"></li><li>Try sending a similar data with changed price in the same time window with a changed timestamp: <code>2023-04-24 12:00:45,AAPL,600</code>. You should be able to see the <code>maxPrice</code> column showing the maximum price of <code>600</code> as shown below:
<img loading="lazy" alt="Tumbling-Window-Batch-2.png" src="/data-sphere.github.io/assets/images/Tumbling-Window-Batch-2-5d201298e98d58167fe5f5d17cdb356b.png" width="1772" height="514" class="img_ev3q"></li><li>Send data for the next time window for the same symbol: <code>2023-04-24 12:01:10,AAPL,100</code>. You will see another record with the next window created and the latest price as below:
<img loading="lazy" alt="Tumbling-Window-Batch-3.png" src="/data-sphere.github.io/assets/images/Tumbling-Window-Batch-3-3a9f6f411332604b07446ae0972ac5f9.png" width="1658" height="550" class="img_ev3q"></li><li>Try sending another set of data for the new Time Window: <code>2023-04-24 12:01:25,AAPL,200</code>. You should be able to see the new window being updated with the latest maximum price. The previous window remains unchanged as seen below.
<img loading="lazy" alt="Tumbling-Window-Batch-4.png" src="/data-sphere.github.io/assets/images/Tumbling-Window-Batch-4-1a7974483431c16ec514260127bd9543.png" width="1694" height="568" class="img_ev3q"></li></ol><p>Youâ€™ve now implemented aggregations across Tumbling Time Windows!</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="handing-late-data">Handing Late Data<a href="#handing-late-data" class="hash-link" aria-label="Direct link to Handing Late Data" title="Direct link to Handing Late Data">â€‹</a></h3><p>You might have noticed that the above program is maintaining the data in the statestore forever, even though the Spark Application managed to segregate it into Tumbling Time Windows of 1 minute each. To further validate this, try sending some data to an older window <code>2023-04-24 12:00:50,AAPL,700</code> assuming that it has arrived a bit late to your application. You will see the older window being updated with the latest maximum price of <code>700</code> as below:
<img loading="lazy" alt="Tumbling-Window-Batch-5.png" src="/data-sphere.github.io/assets/images/Tumbling-Window-Batch-5-098480ab76a4732192ecd986b369e28b.png" width="1806" height="548" class="img_ev3q">
What happened ? The application retains all the data because we have defined the output mode as <code>Complete</code>. As we have understood in the <code>Output modes</code> <a href="/data-sphere.github.io/docs/beyond-the-batch/spark-structured-streaming">section</a>, <code>Complete</code> output mode is designed to retain the data in the <code>statestore</code> forever. If we want our Spark Application to clean up the data for older windows and also stop accepting any late data in those windows (often a business decision/requirement), we will have to add what Spark calls as <code>Watermark</code> to the application code.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="data-clean-up-with-watermarks">Data Clean Up with Watermarks<a href="#data-clean-up-with-watermarks" class="hash-link" aria-label="Direct link to Data Clean Up with Watermarks" title="Direct link to Data Clean Up with Watermarks">â€‹</a></h3><p>Watermarks are the expiry threshold that we set up in our programs after which the older windows and their data expire. This expiry threshold for watermarks is usually driven by business requirements. Since the older windows cease to exist when watermarks are set, any late data arriving for those windows is also ignored by Spark Applications. Let us make a few changes to our Tumbling Windows Application to enable watermarks to see them in action below (You can find the complete code of this implementation <a href="https://github.com/data-derp/exercise-vanilla-spark/blob/main/src/12%20-%20StreamingTumblingWindowWithWatermark.py" target="_blank" rel="noopener noreferrer">here</a>):</p><ol><li><p>Add the following Watermark code (<a href="https://spark.apache.org/docs/latest/structured-streaming-programming-guide.html#handling-late-data-and-watermarking" target="_blank" rel="noopener noreferrer">watermarks documentation</a>) to the Tumbling Windows Code, just before the <code>groupBy</code> clause for the 1 minute window as below. We are keeping the Watermark expiry threshold of 2 minutes.</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Group the data by window and word and compute the count of each group</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> windowedWords </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> stocksDF\</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">withWatermark</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;EventTime&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;2 minute&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">groupBy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">window</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;EventTime&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;1 minute&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> stocksDF</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">symbol</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">\</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">agg</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">max</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;price&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alias</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;maxPrice&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>Change the output mode to <code>update</code> in the output sink as below</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># This is like writing the data to the sink, console in this case</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">query </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> windowedWords \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">writeStream \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">outputMode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;update&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">format</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;console&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">option</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;truncate&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;false&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">start</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ol><p>Let us now test this program with data streamed from the netcat application</p><ol><li><p>Open a fresh terminal window and open netcat at port <code>9999</code> as shown below:
<img loading="lazy" alt="Start-NetCat.png" src="/data-sphere.github.io/assets/images/Start-NetCat-980ebc8ba58636da4098cb08f08c9933.png" width="1618" height="192" class="img_ev3q"></p></li><li><p>Run the above program from Pycharm. Press Ctrl+Shift+R on your keyboard to run this. Alternatively, you can also open the program in Pycharm and press the execute button as shown below.
<img loading="lazy" alt="Pycharm-Run-Program.png" src="/data-sphere.github.io/assets/images/Pycharm-Run-Program-813daa7233060b42a840ca452014024f.png" width="2800" height="932" class="img_ev3q"></p></li><li><p>You should be able to see the first empty batch with <code>window</code>, <code>symbol</code> and <code>maxPrice</code> columns.</p></li><li><p>Let us now send <strong>2023-04-24 12:00:05,AAPL,500</strong> as data from netcat terminal</p></li><li><p>You should be able to see this data with corresponding time window being created in PyCharm output as below. You might see an empty batch too but it is safe to ignore it as it is coming due to introducing Watermarks in our application code.
<img loading="lazy" alt="Tumbling-Window-Batch-1.png" src="/data-sphere.github.io/assets/images/Tumbling-Window-Batch-1-77282896f64368985aafa6f564c64985.png" width="1752" height="516" class="img_ev3q"></p></li><li><p>Try sending a similar data with changed price in the same time window with a changed timestamp: <strong>2023-04-24 12:00:45,AAPL,600</strong>. You should be able to see the <code>maxPrice</code> column being updated to <code>600</code> in the same time window as below:
<img loading="lazy" alt="Tumbling-Window-Batch-2.png" src="/data-sphere.github.io/assets/images/Tumbling-Window-Batch-2-5d201298e98d58167fe5f5d17cdb356b.png" width="1772" height="514" class="img_ev3q"></p></li><li><p>Let us send the data for the next time window for the same symbol <strong>2023-04-24 12:01:10,AAPL,100</strong>. You will see just the new record for the next time window as below.
<img loading="lazy" alt="Tumbling-Window-Watermark-Batch-5.png" src="/data-sphere.github.io/assets/images/Tumbling-Window-Watermark-Batch-5-5bba443b656910445cf2e2b05901aacd.png" width="2046" height="496" class="img_ev3q"></p></li><li><p>The previous time window <strong>[2023-04-24 12:00:00, 2023-04-24 12:01:00]</strong> is nicely preserved in the statestore, it is just not displayed above (this is a feature). To validate this, try sending some data to the previous window <strong>2023-04-24 12:00:50,AAPL,700</strong>. The previous window will now appear with the latest <code>maxPrice</code>. This time the next window <strong>[2023-04-24 12:01:00, 2023-04-24 12:02:00]</strong> will be missing but thatâ€™s alright isnâ€™t it?
<img loading="lazy" alt="Tumbling-Window-Watermark-Batch-7.png" src="/data-sphere.github.io/assets/images/Tumbling-Window-Watermark-Batch-7-9efe97a95d9c627eabb83d1d992e7288.png" width="1634" height="486" class="img_ev3q"></p></li><li><p>Late data is still being processed by our application. That is because the Event data has still not reached the Watermark boundary. The Watermark boundary is calculated using the following formula:</p><ul><li>Max (Event Time) - Watermark = Watermark Boundary</li></ul><p>We can check if the Watermark Boundary has reached for the late data sent above. The time at which the latest event was sent is <strong>12:01:10</strong> (as per 2023-04-24 12:01:10,AAPL,100 record). So the calculation will be</p><ul><li>12:01:10 - 2 mins (120 seconds) = 11:59:10</li></ul><p>This means that all the windows ending before 11:59:10 will expire. The ending time window for our late data is 12:01:00 which is greater than the Watermark Boundary therefore the late date is processed by our application.</p></li><li><p>Let us now send the data that will create the new 3rd window <strong>2023-04-24 12:03:10,AAPL,100</strong> record. We should see a new window created for this data:
<img loading="lazy" alt="Tumbling-Window-Watermark-Batch-8.png" src="/data-sphere.github.io/assets/images/Tumbling-Window-Watermark-Batch-8-2d26ee8aaa6767cea91c70a61ee36fc5.png" width="1688" height="550" class="img_ev3q"></p></li><li><p>Calculate the Watermark boundary again:</p><ul><li>12:03:10 - 2 mins (120 seconds) = 12:01:10</li></ul></li><li><p>The Watermark boundary comes as <strong>12:01:10</strong> as seen above. This is later than the end time window of our very first window which is <strong>12:01:00</strong>. This means if we send the late data again to the very first window, it should not be processed and also the data for that window should be dropped from the statestore. So let us send <strong>2023-04-24 12:00:50,AAPL,100</strong> again from our terminal. You should see the batch coming up empty as below. That is just Sparkâ€™s way of showing that the older window is dropped and that the watermark is working. :-)
<img loading="lazy" alt="Tumbling-Window-Watermark-Batch-10.png" src="/data-sphere.github.io/assets/images/Tumbling-Window-Watermark-Batch-10-9b267afcc87d28971029f07e46d83d99.png" width="1368" height="442" class="img_ev3q"></p></li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="sliding-time-windows">Sliding Time Windows<a href="#sliding-time-windows" class="hash-link" aria-label="Direct link to Sliding Time Windows" title="Direct link to Sliding Time Windows">â€‹</a></h3><p>While Tumbling Time Windows fit well with use cases that require static buckets, it is necessary to employ Sliding Time Windows for use cases that require more flexibility, like calculating an average for a 1 minute window every 15 seconds. Sliding Time windows are aptly named as they slide across a data stream, or move as time progresses. Unlike Tumbling Windows, Sliding Windows are overlapping windows and a single event can belong to more than 1 window.</p><p>A sample use case requiring the usage of Sliding Time Windows could be: calculate the maximum price of a stock symbol in a stock market application every 30 seconds in 1 minute windows. The previous implementation of Tumbling Windows will not work here because new windows are required to be generated every 30 seconds (and they must overlap).</p><p>We can see this Sliding Window in action:</p><ol><li><p>Add a 3rd argument of <code>30 seconds</code> to the window declaration and also the aggregate function to max(price) as <code>MaximumPrice</code> as shown in the code below. (As in the previous example, you can find the complete code of this example <a href="https://github.com/data-derp/exercise-vanilla-spark/blob/main/src/13%20-%20StreamingSlidingWindowWithWatermark.py" target="_blank" rel="noopener noreferrer">here</a>
<img loading="lazy" alt="Sliding-Window-Sliding-Argument.png" src="/data-sphere.github.io/assets/images/Sliding-Window-Sliding-Argument-1ede9ee47142bf1820dce1bcd58c5419.png" width="1916" height="352" class="img_ev3q"></p></li><li><p>Let us now test this program with data streamed from the netcat application. Open a fresh terminal window and open netcat at port 9999 as shown below
<img loading="lazy" alt="Start-NetCat.png" src="/data-sphere.github.io/assets/images/Start-NetCat-980ebc8ba58636da4098cb08f08c9933.png" width="1618" height="192" class="img_ev3q"></p></li><li><p>Run the above program from Pycharm. Press Ctrl+Shift+R on your keyboard to run this. Alternatively, you can also open the program in Pycharm and press the execute button as shown below.
<img loading="lazy" alt="Pycharm-Run-Program.png" src="/data-sphere.github.io/assets/images/Pycharm-Run-Program-813daa7233060b42a840ca452014024f.png" width="2800" height="932" class="img_ev3q"></p></li><li><p>You should be able to see the first empty batch with <code>window</code>, <code>symbol</code> and <code>MaximumPrice</code> columns.</p></li><li><p>Let us start with sending the first event from netcat as <strong>2023-04-24 12:05:15,AAPL,500</strong>. The output can be seen below:
<img loading="lazy" alt="Sliding-Window-Batch-1.png" src="/data-sphere.github.io/assets/images/Sliding-Window-Batch-1-a6796fdfab17c89c4b26a06f6a60d024.png" width="1986" height="600" class="img_ev3q">
Two time windows are displayed in the output. The event time of the streaming data is 12:05:15 so as expected, the window <strong>[2023-04-24 12:05:00, 2023-04-24 12:06:00]</strong> is displayed. Additionally, our event (streamed at 12:05:15) also is a member of the preceding and overlapping window <strong>[2023-04-24 12:04:30, 2023-04-24 12:05:30]</strong>. Because the window duration is 1 minute and the sliding time is 30 seconds, this event falls into two windows.</p></li><li><p>Let us send another data event from netcat as <strong>2023-04-24 12:04:31,AAPL,450</strong> and check the output below:
<img loading="lazy" alt="Sliding-Window-Batch-3.png" src="/data-sphere.github.io/assets/images/Sliding-Window-Batch-3-e0bbc1c374a678fb30d168af42221e01.png" width="1696" height="584" class="img_ev3q">
The data was streamed at 12:04:31 with a price of 450. This is a member of the <strong>[2023-04-24 12:04:30, 2023-04-24 12:05:30]</strong> window. Now this window already had the MaximumPrice of 500 from the previous micro-batch. The resulting aggregated value under MaximumPrice remains at 500 because the existing value (500) is greater than the value of the event of the current microbatch (450).</p><p>Since we have defined the <code>sliding time</code> as 30 seconds, the value (450) streamed at 12:04:31 also registers itself in the <strong>[2023-04-24 12:04:00, 2023-04-24 12:05:00]</strong> time window, which is why we also see that window in the above output.</p><p>Let us take a moment now to summarize the total number of sliding windows we have in the state store as of</p><table><thead><tr><th align="center">Window</th><th align="center">Maximum Price</th><th align="center">Persisted in statestore ?</th><th align="center">Appears in the output ?</th></tr></thead><tbody><tr><td align="center">[2023-04-24 12:04:00, 2023-04-24 12:05:00]</td><td align="center">450</td><td align="center">True</td><td align="center">True</td></tr><tr><td align="center">[2023-04-24 12:04:30, 2023-04-24 12:05:30]</td><td align="center">500</td><td align="center">True</td><td align="center">True</td></tr><tr><td align="center">[2023-04-24 12:05:00, 2023-04-24 12:06:00]</td><td align="center">500</td><td align="center">True</td><td align="center">False</td></tr></tbody></table></li><li><p>Let us now send another data event from netcat as <strong>2023-04-24 12:05:31,AAPL,460</strong> and check the output below
<img loading="lazy" alt="Sliding-Window-Batch-4.png" src="/data-sphere.github.io/assets/images/Sliding-Window-Batch-4-4f702fef012c7265df33dbe2fa438651.png" width="1718" height="608" class="img_ev3q"></p><p>The data was streamed at <strong>12:05:31</strong> with <strong>460</strong> as the price. This registers it under the <strong>[2023-04-24 12:05:00, 2023-04-24 12:06:00]</strong> window which already has the MaximumPrice of 500 from the previous micro-batch and because 500 is greater than 460, the MaximumPrice is remains at 500. This additionally validates that the window had been in the statestore from the previous micro-batch.</p><p>Like the previous micro-batch, the event also registers itself in the <strong>[2023-04-24 12:05:30, 2023-04-24 12:06:30]</strong> time window, which is also displayed in the above output.</p><p>In summary, we have 4 windows in statestore now as below</p><table><thead><tr><th align="center">Window</th><th align="center">Maximum Price</th><th align="center">Persisted in statestore</th><th align="center">Appears in the output</th></tr></thead><tbody><tr><td align="center">[2023-04-24 12:04:00, 2023-04-24 12:05:00]</td><td align="center">450</td><td align="center">True</td><td align="center">False</td></tr><tr><td align="center">[2023-04-24 12:04:30, 2023-04-24 12:05:30]</td><td align="center">500</td><td align="center">True</td><td align="center">False</td></tr><tr><td align="center">[2023-04-24 12:05:00, 2023-04-24 12:06:00]</td><td align="center">500</td><td align="center">True</td><td align="center">True</td></tr><tr><td align="center">[2023-04-24 12:05:30, 2023-04-24 12:06:30]</td><td align="center">460</td><td align="center">True</td><td align="center">True</td></tr></tbody></table></li><li><p>Letâ€™s send an event in the time range of the oldest window that we have in the statestore to prove that it still exists. Send a data event from netcat as <strong>2023-04-24 12:04:32,AAPL,470</strong> and check the output:
<img loading="lazy" alt="Sliding-Window-Batch-6.png" src="/data-sphere.github.io/assets/images/Sliding-Window-Batch-6-d5f50b40eedf4d049068cb1c0f05fc33.png" width="1740" height="588" class="img_ev3q"></p><p>We do indeed see the oldest window appearing with the MaximumPrice of 470 and we also see a second window. The 3rd and 4th windows are not displayed, but from previous experience, we know that they are still in the statestore !</p></li></ol><p>You might have observed that all the data above 4 windows is saved in the statestore even though we have a Watermark declaration of 2 minutes. This is happening because the application has not yet not reached the Watermark Expiry Threshold as we have seen in the Tumbling Windows example.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="sliding-time-windows-with-watermarks">Sliding Time Windows with Watermarks<a href="#sliding-time-windows-with-watermarks" class="hash-link" aria-label="Direct link to Sliding Time Windows with Watermarks" title="Direct link to Sliding Time Windows with Watermarks">â€‹</a></h3><p>Similar to our Tumbling Windows example, weâ€™ll also need to handle late data in Sliding Time Windows. Similarly, weâ€™ll use Watermarks:</p><ol><li><p>Weâ€™ll start from where we left off in the Sliding Window example:
<img loading="lazy" alt="Sliding-Window-Batch-6.png" src="/data-sphere.github.io/assets/images/Sliding-Window-Batch-6-d5f50b40eedf4d049068cb1c0f05fc33.png" width="1740" height="588" class="img_ev3q">
Note that the following 4 windows are in the statestore:</p><table><thead><tr><th align="center">Window</th><th align="center">Maximum Price</th><th align="center">Persisted in statestore</th><th align="center">Appears in the output</th></tr></thead><tbody><tr><td align="center">[2023-04-24 12:04:00, 2023-04-24 12:05:00]</td><td align="center">470</td><td align="center">True</td><td align="center">True</td></tr><tr><td align="center">[2023-04-24 12:04:30, 2023-04-24 12:05:30]</td><td align="center">500</td><td align="center">True</td><td align="center">True</td></tr><tr><td align="center">[2023-04-24 12:05:00, 2023-04-24 12:06:00]</td><td align="center">500</td><td align="center">True</td><td align="center">False</td></tr><tr><td align="center">[2023-04-24 12:05:30, 2023-04-24 12:06:30]</td><td align="center">460</td><td align="center">True</td><td align="center">False</td></tr></tbody></table></li><li><p>Send a new event:  <strong>2023-04-24 12:07:01,AAPL,480</strong> and check the output:
<img loading="lazy" alt="Sliding-Window-Batch-7.png" src="/data-sphere.github.io/assets/images/Sliding-Window-Batch-7-79c91b9172509f3ea6a46489735b669d.png" width="1862" height="604" class="img_ev3q">
There is nothing unexpected here. We have two new windows created making it a total of 6 active sliding windows:</p><table><thead><tr><th align="center">Window</th><th align="center">Maximum Price</th><th align="center">Persisted in statestore</th><th align="center">Appears in the output</th></tr></thead><tbody><tr><td align="center">[2023-04-24 12:04:00, 2023-04-24 12:05:00]</td><td align="center">470</td><td align="center">True</td><td align="center">False</td></tr><tr><td align="center">[2023-04-24 12:04:30, 2023-04-24 12:05:30]</td><td align="center">500</td><td align="center">True</td><td align="center">False</td></tr><tr><td align="center">[2023-04-24 12:05:00, 2023-04-24 12:06:00]</td><td align="center">500</td><td align="center">True</td><td align="center">False</td></tr><tr><td align="center">[2023-04-24 12:05:30, 2023-04-24 12:06:30]</td><td align="center">460</td><td align="center">True</td><td align="center">False</td></tr><tr><td align="center">[2023-04-24 12:06:30, 2023-04-24 12:07:30]</td><td align="center">480</td><td align="center">True</td><td align="center">True</td></tr><tr><td align="center">[2023-04-24 12:07:00, 2023-04-24 12:08:00]</td><td align="center">480</td><td align="center">True</td><td align="center">True</td></tr></tbody></table></li><li><p>Send a new event <strong>2023-04-24 12:04:33,AAPL,490</strong> from the terminal. This should hypothetically register itself with  two windows in the statestore: <strong>[2023-04-24 12:04:00, 2023-04-24 12:05:00]</strong> and <strong>[2023-04-24 12:04:30, 2023-04-24 12:05:30]</strong>
<img loading="lazy" alt="Sliding-Window-Batch-9.png" src="/data-sphere.github.io/assets/images/Sliding-Window-Batch-9-1577578cd8d89bd731d8ae525466b5f3.png" width="1794" height="538" class="img_ev3q">
However, we only see that it has registered itself with the second window (<strong>[2023-04-24 12:04:30, 2023-04-24 12:05:30]</strong>). When in doubt, check the Watermark Expiry Threshold, using the below formula:</p><ul><li>Max (Event Time) - Watermark = Watermark Boundary</li></ul><p>The event time from the data sent in previous step is 12:07:01 (represents the max event time) so the calculation is represented as:</p><ul><li>12:07:01 - 2 minutes (Watermark) = 12:05:01</li></ul><p>Our current Watermark Expiry Threshold is therefore 12:05:01, which is later than the    end interval of our very first Window (<strong>[2023-04-24 12:04:00, 2023-04-24 12:05:00]</strong>), which in turn explains why our data was not registered against that window. In other words,  our very first window  expired and no additional data can be registered here (it is ignored). The data shown above is from our 2nd window (<strong>[2023-04-24 12:04:30, 2023-04-24 12:05:30]</strong>). This is within the Watermark Expiry Threshold;  therefore, the 2nd window is still active and exists in the statestore. The other 4 windows are also in the statestore but are simply not displayed.</p></li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">â€‹</a></h3><p>In this section, weâ€™ve learned about how to aggregate data in both Tumbling and Sliding Time Windows which is used in situations where aggregations are made on <!-- -->[near]<!-- --> real-time data. Weâ€™ve additionally learned how to handle late data with both types of Windows, which is a very common and realistic occurrence, and under what circumstances data remains in the statestore.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/beyond-the-batch/handling-late-data.mdx" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/data-sphere.github.io/docs/beyond-the-batch/checkpointing"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Checkpointing</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/data-sphere.github.io/docs/beyond-the-batch/stateful-streaming-nutshell"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Stateful Streaming in a Nutshell</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#time-windows" class="table-of-contents__link toc-highlight">Time Windows</a><ul><li><a href="#tumbling-time-windows" class="table-of-contents__link toc-highlight">Tumbling Time windows</a></li><li><a href="#handing-late-data" class="table-of-contents__link toc-highlight">Handing Late Data</a></li><li><a href="#data-clean-up-with-watermarks" class="table-of-contents__link toc-highlight">Data Clean Up with Watermarks</a></li><li><a href="#sliding-time-windows" class="table-of-contents__link toc-highlight">Sliding Time Windows</a></li><li><a href="#sliding-time-windows-with-watermarks" class="table-of-contents__link toc-highlight">Sliding Time Windows with Watermarks</a></li><li><a href="#conclusion" class="table-of-contents__link toc-highlight">Conclusion</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/data-sphere.github.io/docs/tour_agenda">Tutorial</a></li></ul></div><div class="col footer__col"><div class="footer__title">Info</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/Data-Dynamos/data-sphere.github.io" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2024 DataSphere</div></div></div></footer></div>
<script src="/data-sphere.github.io/assets/js/runtime~main.2d4a7005.js"></script>
<script src="/data-sphere.github.io/assets/js/main.2340525f.js"></script>
</body>
</html>